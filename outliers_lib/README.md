# Статистические методы поиска выбросов

## Оглавление

1. [Понятие выброса](#понятие-выброса)
2. [Метод межквартильного размаха](#метод-1-метод-межквартильного-размаха)
3. [Метод z-отклонений (метод сигм)](#метод-2-метод-z-отклонений-метод-сигм)
4. [Метод отсечения по квартилям](#метод-3-метод-отсечения-по-квартилям)
5. [Реализация методов](#реализация-методов)
6. [Пример использования](#пример-использования)
7. [Инструменты и источники](#использованные-инструменты-и-библиотеки)

## Понятие выброса

Одним из этапов очистки данных является поиск выбросов.

***Выброс (аномалия)*** - это наблюдение, которое существенно выбивается из общего распределения и сильно отличается от других данных.

В данном разделе рассматриваются статистические методы поиска выбросов, а именно:

1. Метод межквартиального размаха
2. Метод z-отклонений (метод сигм)
3. Метод отсечения по квартилям

## Метод 1. Метод межквартильного размаха

![Диаграмма разброса](../images/boxplot.png)

### Алгоритм метода 1

1. Вычислить 25-ую и 75-ую квантили (1 и 3 квартили) - $Q_{25}$ и $Q_{75}$ для признака, который мы исследуем
2. Вычислить межквартильное расстояние:  
    * $IQR=Q_{75}-Q_{25}$
3. Определить верхнюю и нижнюю границы Тьюки:

    * $bound_{upper} = Q_{75} + 1.5*IQR$

    * $bound_{lower} = Q_{25} - 1.5*IQR$
4. Найти наблюдения, которые выходят за пределы границ

### Недостатки метода 1

Метод требует, чтобы признак, на основе которого происходит поиск выбросов, был распределен нормально.

### Модификация метода 1

Можно попробовать воспользоваться методами преобразования данных, например, логарифмированием, чтобы попытаться свести распределение к нормальному или хотя бы к симметричному.

Также можно добавить вариативности количеству квартильных размахов в левую и правую сторону распределений.

## Метод 2. Метод z-отклонений (метод сигм)

Правило трех сигм гласит: что, если распределение данных является нормальным, то 99.73% лежат в интервале: $(\mu-3 \sigma$ , $\mu+3 \sigma)$,
где  

* $\mu$ - математическое ожидание (для выборки это среднее значение)
* $\sigma$ - стандартное отклонение.

Наблюдения, которые лежат за пределами этого интервала будут считаться выбросами.

![Диаграмма разброса 2](../images/method_sigm.png)

### Алгоритм метода 2

1. Вычислить среднее и стандартное отклонение $\mu$ и $\sigma$ для признака, который мы исследуем
2. Определить верхнюю и нижнюю границы:
    * $bound_{upper} = \mu - 3 * \sigma$

    * $bound_{lower} = \mu + 3 * \sigma$
3. Найти наблюдения, которые выходят за пределы границ

### Недостатки метода 2

Метод требует, чтобы признак, на основе которого происходит поиск выбросов, был распределен нормально.

### Модификация метода 2

Можно попробовать воспользоваться методами преобразования данных, например, логарифмированием, чтобы попытаться свести распределение к нормальному или хотя бы к симметричному.

Также можно добавить вариативности количеству стандартных отклонений в левую и правую сторону распределений.

## Метод 3. Метод отсечения по квартилям

Метод крайне прост и предполагает установление границ наблюдений по квартилям, величину которых определяет пользователь в аргументах функции.

Наблюдения, которые лежат за пределами этого интервала будут считаться выбросами.

### Алгоритм метода 3

1. Вычислить квартили, переданные в аргументах функции (по умолчанию - 1 и 99) - $Q_{1}$ и $Q_{99}$ для признака, который мы исследуем
2. Вычислить межквартильное расстояние:  
    * $IQR=Q_{99}-Q_{1}$
3. Найти наблюдения, которые выходят за пределы границ

### Недостатки метода 3

Метод по сути просто отсекает часть наблюдений, лежащих за установленными границами, не учитывая специфику распределения, что потенциально может привести к потере существенных данных.

## Реализация методов

Методы реализованы в виде функций

* find_outliers_iqr()
* find_outliers_z_score()
* find_outliers_quantile()

Функции представлены в файле find_outliers.py. К функциям предоставлена документация.

## Пример использования

Обязательными аргументами функций, реализующих методы поиска выбросов являются:

* data (pandas.DataFrame): набор данных (таблица)
* feature (str): имя признака, на основе которого происходит поиск выбросов

Использование классических подходов без модификаций:

```python
# Метод межквартильного размаха
from outliers_lib.find_outliers import find_outliers_iqr

outliers_iqr, cleaned_iqr = find_outliers_iqr(data, feature)

# Метод z-отклонений
from outliers_lib.find_outliers import find_outliers_z_score

outliers_z_score, cleaned_z_score = find_outliers_z_score(data, feature)

# Метод отсечения по квартилям
from outliers_lib.find_outliers import find_outliers_quantile

outliers_quantile, cleaned_quantile = find_outliers_quantile(data, feature)
```

Использование методов с предварительным логарифмированием:

```python
outliers_iqr, cleaned_iqr = find_outliers_iqr(data, feature, log=True)
outliers_z_score, cleaned_z_score = find_outliers_z_score(data, feature, log=True)
```

Использование методов с предварительным логарифмированием (где допустимо) и добавлением вариативности разброса:

```python
outliers_iqr, cleaned_iqr = find_outliers_iqr(data, feature, log=True, left=2, right=2)
outliers_z_score, cleaned_z_score = find_outliers_z_score(data, feature, log=True, left=2, right=2)
outliers_quantile, cleaned_quantile = find_outliers_quantile(data, feature, left=0.22, right=0.88)
```

## Использованные инструменты и библиотеки

* numpy (1.23.2)
* pandas (1.4.4)

## Дополнительные источники

* [Нормальное распределение](https://ru.wikipedia.org/wiki/Нормальное_распределение)
* [Метод межквартильного размаха](https://recture.ru/common/chto-takoe-pravilo-mezhkvartilnogo-razmaha/)
* [Правило трех сигм](https://wiki.loginom.ru/articles/3-sigma-rule.html)
